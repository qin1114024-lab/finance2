import { GoogleGenAI } from "@google/genai";
import { Transaction, BankAccount, Budget, FinancialGoal } from "./types";

export const getFinancialAdvice = async (
  transactions: Transaction[], 
  accounts: BankAccount[],
  budgets: Budget[],
  goals: FinancialGoal[]
): Promise<string> => {
  // process.env.API_KEY 會在佈署時被 GitHub Action 的 sed 指令替換成實際金鑰
  const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
  
  const currentMonth = new Date().toISOString().slice(0, 7);
  const monthTransactions = transactions.filter(t => t.date.startsWith(currentMonth));
  
  const totalIncome = monthTransactions
    .filter(t => t.type === 'INCOME')
    .reduce((sum, t) => sum + t.amount, 0);
  
  const totalExpense = monthTransactions
    .filter(t => t.type === 'EXPENSE')
    .reduce((sum, t) => sum + t.amount, 0);

  const categorySpending = monthTransactions
    .filter(t => t.type === 'EXPENSE')
    .reduce((acc: Record<string, number>, t) => {
      acc[t.category] = (acc[t.category] || 0) + t.amount;
      return acc;
    }, {});

  const budgetSummary = budgets.map(b => {
    const spent = categorySpending[b.category] || 0;
    return `${b.category}: 預算 ${b.limit}, 已花費 ${spent} (${b.limit > 0 ? ((spent/b.limit)*100).toFixed(1) : 0}%)`;
  }).join('\n');

  const goalsSummary = goals.map(g => 
    `${g.name}: 目標 ${g.targetAmount}, 目前 ${g.currentAmount} (${g.targetAmount > 0 ? ((g.currentAmount/g.targetAmount)*100).toFixed(1) : 0}%)`
  ).join('\n');

  const dataSummary = `
    [本月數據]
    總收入: ${totalIncome}
    總支出: ${totalExpense}
    各類支出統計: ${JSON.stringify(categorySpending)}
    
    [預算執行]
    ${budgetSummary || '未設定預算'}
    
    [理財目標]
    ${goalsSummary || '未設定目標'}
    
    [資產總量]
    帳戶數量: ${accounts.length}
    總資產: ${accounts.reduce((sum, a) => sum + a.balance, 0)}
  `;

  try {
    const response = await ai.models.generateContent({
      model: "gemini-3-flash-preview",
      contents: `你是一位資深理財專家。請針對以下用戶的財務狀況，提供具體的優缺點分析、預算改進建議以及達成目標的動力喊話（請用繁體中文，分為 3-5 點，語氣要親切且專業）：\n${dataSummary}`,
      config: {
        temperature: 0.7,
      },
    });

    return response.text || "目前無法產生建議，請稍後再試。";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "獲取 AI 建議時發生錯誤，請檢查您的網路或 API 設定。";
  }
};
